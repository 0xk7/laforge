###########################################################
# LAFORGE GENERATED TERRAFORM CONFIGURATION
# -- WARNING --
# This file is automatically generated. Do not edit it's
# contents directly. Use Laforge and re build this file.
###########################################################

terraform {
  backend "etcdv3" {
    prefix = "{{ $.Team.ID }}/terraform.tfstate"
    endpoints = [
      "https://{{ index $.Build.Config "etcd_master" }}",
      "https://{{ index $.Build.Config "etcd_slave" }}",
    ]
    username = "{{ index $.Build.Config "etcd_username" }}"
    password = "{{ index $.Build.Config "etcd_password" }}"
  }
}

data "aws_ami" "ubuntu16" {
  most_recent = true
  filter {
    name   = "name"
    values = ["ubuntu/images/hvm-ssd/ubuntu-xenial-16.04-amd64-server-*"]
  }
  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
  filter {
    name   = "root-device-type"
    values = ["ebs"]
  }
  filter {
    name   = "architecture"
    values = ["x86_64"]
  }
  owners = ["099720109477"] # Canonical AWS ID
}

data "aws_ami" "ubuntu18" {
  most_recent = true
  filter {
    name   = "name"
    values = ["ubuntu/images/hvm-ssd/ubuntu-bionic-18.04-amd64-server-*"]
  }
  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
  filter {
    name   = "root-device-type"
    values = ["ebs"]
  }
  filter {
    name   = "architecture"
    values = ["x86_64"]
  }
  owners = ["099720109477"] # Canonical AWS ID
}

data "aws_ami" "ubuntu20" {
  most_recent = true
  filter {
    name   = "name"
    values = ["ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*"]
  }
  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
  filter {
    name   = "root-device-type"
    values = ["ebs"]
  }
  filter {
    name   = "architecture"
    values = ["x86_64"]
  }
  owners = ["099720109477"] # Canonical AWS ID
}

data "aws_ami" "centos7" {
  most_recent = true
  filter {
    name   = "name"
    values = ["CentOS 7.*"]
  }
  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
  filter {
    name   = "root-device-type"
    values = ["ebs"]
  }
  filter {
    name   = "architecture"
    values = ["x86_64"]
  }
  owners = ["125523088429"] # CentOS AWS ID
}

data "aws_ami" "centos8" {
  most_recent = true
  filter {
    name   = "name"
    values = ["CentOS 8.*"]
  }
  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
  filter {
    name   = "root-device-type"
    values = ["ebs"]
  }
  filter {
    name   = "architecture"
    values = ["x86_64"]
  }
  owners = ["125523088429"] # CentOS AWS ID
}

data "aws_ami" "debian8" {
  most_recent = true
  filter {
    name   = "name"
    values = ["debian-jessie-amd64-hvm-*"]
  }
  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
  filter {
    name   = "root-device-type"
    values = ["ebs"]
  }
  filter {
    name   = "architecture"
    values = ["x86_64"]
  }
  owners = ["379101102735"] # Debian AWS ID
}

data "aws_ami" "debian9" {
  most_recent = true
  filter {
    name   = "name"
    values = ["debian-stretch-hvm-*"]
  }
  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
  filter {
    name   = "root-device-type"
    values = ["ebs"]
  }
  filter {
    name   = "architecture"
    values = ["x86_64"]
  }
  owners = ["379101102735"] # Debian AWS ID
}

data "aws_ami" "debian10" {
  most_recent = true
  filter {
    name   = "name"
    values = ["debian-10-amd64-*"]
  }
  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
  filter {
    name   = "root-device-type"
    values = ["ebs"]
  }
  filter {
    name   = "architecture"
    values = ["x86_64"]
  }
  owners = ["136693071363"] # Debian AWS ID
}

data "aws_ami" "w2k12" {
  most_recent = true
  filter {
    name   = "name"
    values = ["Windows_Server-2012-R2_RTM-English-64Bit-Base-*"]
  }
  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
  filter {
    name   = "root-device-type"
    values = ["ebs"]
  }
  filter {
    name   = "architecture"
    values = ["x86_64"]
  }
  owners = ["801119661308"] # Amazon AWS ID
}

data "aws_ami" "w2k16" {
  most_recent = true
  filter {
    name   = "name"
    values = ["Windows_Server-2016-English-Full-Base-*"]
  }
  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
  filter {
    name   = "root-device-type"
    values = ["ebs"]
  }
  filter {
    name   = "architecture"
    values = ["x86_64"]
  }
  owners = ["801119661308"] # Amazon AWS ID
}

data "aws_ami" "w2k19" {
  most_recent = true
  filter {
    name   = "name"
    values = ["Windows_Server-2019-English-Full-Base-*"]
  }
  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
  filter {
    name   = "root-device-type"
    values = ["ebs"]
  }
  filter {
    name   = "architecture"
    values = ["x86_64"]
  }
  owners = ["801119661308"] # Amazon AWS ID
}

data "aws_ami" "w2k12-sql" {
  most_recent = true
  filter {
    name   = "name"
    values = ["Windows_Server-2012-R2_RTM-English-64Bit-SQL_2012_SP4_Enterprise-*"]
  }
  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
  filter {
    name   = "root-device-type"
    values = ["ebs"]
  }
  filter {
    name   = "architecture"
    values = ["x86_64"]
  }
  owners = ["801119661308"] # Amazon AWS ID
}

data "aws_ami" "w2k16-sql" {
  most_recent = true
  filter {
    name   = "name"
    values = ["Windows_Server-2016-English-64Bit-SQL_2012_SP4_Enterprise-*"]
  }
  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
  filter {
    name   = "root-device-type"
    values = ["ebs"]
  }
  filter {
    name   = "architecture"
    values = ["x86_64"]
  }
  owners = ["801119661308"] # Amazon AWS ID
}

data "aws_ami" "w2k19-sql" {
  most_recent = true
  filter {
    name   = "name"
    values = ["Windows_Server-2019-English-Full-SQL_2016_SP2_Enterprise-*"]
  }
  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
  filter {
    name   = "root-device-type"
    values = ["ebs"]
  }
  filter {
    name   = "architecture"
    values = ["x86_64"]
  }
  owners = ["801119661308"] # Amazon AWS ID
}

data "aws_ami" "kali" {
  most_recent = true
  filter {
    name   = "name"
    values = ["kali-linux-*"]
  }
  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
  filter {
    name   = "root-device-type"
    values = ["ebs"]
  }
  filter {
    name   = "architecture"
    values = ["x86_64"]
  }
  owners = ["679593333241"] # Amazon AWS ID
}

variable "vmsize" {
  type = "map"
  default = {
    "nano" = "t2.nano"
    "micro" = "t2.micro"
    "small" = "t2.small"
    "medium" = "t2.medium"
    "large" = "t2.large"
    "xlarge" = "t2.xlarge"
  }
}

provider "aws" {
  region = "{{ index $.Build.Config "aws_region" }}"
  shared_credentials_file = "{{ index $.Build.Config "aws_cred_file" }}"
  profile                 = "{{ index $.Build.Config "aws_cred_profile" }}"
}

{{ $dnsz := index $.Build.Config "aws_dns_zone_id" }}

resource "aws_route53_zone" "{{ $dnsz }}" {
  name = "{{ $dnsz }}.cptc.network"
}

{{ $team_vpc_name := printf "%s-t%d-vpc" $.Environment.Base $.Team.TeamNumber }}

resource "aws_vpc" "vpc" {
  cidr_block       = "{{ index $.Build.Config "vpc_cidr" }}"
  enable_dns_hostnames = true
  enable_dns_support = true

  tags = {
    Name = "{{ $team_vpc_name }}"
  }
}

resource "aws_internet_gateway" "vpc_default" {
  vpc_id = "${aws_vpc.vpc.id}"
}

resource "aws_route" "vpc_internet_access" {
  route_table_id         = "${aws_vpc.vpc.main_route_table_id}"
  destination_cidr_block = "0.0.0.0/0"
  gateway_id             = "${aws_internet_gateway.vpc_default.id}"
}

resource "aws_security_group" "allow_all" {
  name        = "allow_all"
  description = "Allow all traffic to ec2, filtering handled by vpc acl rules"
  vpc_id      = "${aws_vpc.vpc.id}"

  ingress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }

  tags = {
    Name = "allow_all"
  }
}

{{ $teamrev := (index $.Laforge.StateManager.NewRevs $.Team.Path) }}
{{ $teamrev = $teamrev.Touch }}


resource "local_file" "team_lf_revision" {
  content = {{ $teamrev.ToJSONString | hclstring }}
  filename = "./.team.lfrevision"

  depends_on = [
    "aws_vpc.vpc",
  ]
}

{{ $team_key_name := printf "%s-t%d-key" $.Environment.Base $.Team.TeamNumber }}
resource "aws_key_pair" "laforge" {
  key_name   = "{{ $team_key_name }}"
  public_key = "${chomp(file("{{ index $.Build.Config "rel_ssh_public_key_file" }}"))} root@laforge"
}

{{ range $pnetid, $pnet := $.Team.ProvisionedNetworks }}
{{ $net := $pnet.Network }}
{{ $netname := $net.Path }}
// network = {{ $netname }}

{{ $network_subnet_name := printf "%s-t%d-%s" $.Environment.Base $.Team.TeamNumber $net.Base }}

resource "aws_subnet" "{{ $network_subnet_name }}" {
  vpc_id     = "${aws_vpc.vpc.id}"
  cidr_block = "{{ $net.CIDR }}"
  map_public_ip_on_launch = true

  tags = {
    Name = "{{ $netname }}"
  }
}

// aws_network_acl
resource "aws_network_acl" "{{ $network_subnet_name }}_acl" {
  vpc_id = "${aws_vpc.vpc.id}"
  subnet_ids = ["${aws_subnet.{{ $network_subnet_name }}.id}",]
}

resource "aws_network_acl_rule" "{{ $network_subnet_name }}-{{ $team_vpc_name }}-deny-mgmt-int" {
  network_acl_id = "${aws_network_acl.{{ $network_subnet_name }}_acl.id}"
  rule_number    = 99
  egress         = false
  protocol       = "tcp"
  rule_action    = "deny"
  cidr_block     = "{{ index $.Build.Config "vpc_cidr" }}"
  from_port      = 9971
  to_port        = 9971
}

resource "aws_network_acl_rule" "{{ $network_subnet_name }}-{{ $team_vpc_name }}-allow-out" {
  network_acl_id = "${aws_network_acl.{{ $network_subnet_name }}_acl.id}"
  rule_number    = 100
  egress         = true
  protocol       = "all"
  rule_action    = "allow"
  cidr_block     = "0.0.0.0/0"
  icmp_type      = -1
  icmp_code      = -1
}

resource "aws_network_acl_rule" "{{ $network_subnet_name }}-{{ $team_vpc_name }}-allow-emp-in-tcp" {
  network_acl_id = "${aws_network_acl.{{ $network_subnet_name }}_acl.id}"
  rule_number    = 100
  egress         = false
  protocol       = "tcp"
  rule_action    = "allow"
  cidr_block     = "0.0.0.0/0"
  from_port      = 32768
  to_port        = 65535
}

resource "aws_network_acl_rule" "{{ $network_subnet_name }}-{{ $team_vpc_name }}-allow-emp-in-udp" {
  network_acl_id = "${aws_network_acl.{{ $network_subnet_name }}_acl.id}"
  rule_number    = 101
  egress         = false
  protocol       = "udp"
  rule_action    = "allow"
  cidr_block     = "0.0.0.0/0"
  from_port      = 32768
  to_port        = 65535
}

resource "aws_network_acl_rule" "{{ $network_subnet_name }}-{{ $team_vpc_name }}-allow-vdi-int" {
  network_acl_id = "${aws_network_acl.{{ $network_subnet_name }}_acl.id}"
  rule_number    = 102
  egress         = false
  protocol       = "all"
  rule_action    = "allow"
  cidr_block     = "{{ index $.Build.Config "vpc_cidr" }}"
  icmp_type      = -1
  icmp_code      = -1
}

{{ if ne (index $.Build.Config "admin_ip") "" }}
resource "aws_network_acl_rule" "{{ $network_subnet_name }}-{{ $team_vpc_name }}-allow-admin" {
  network_acl_id = "${aws_network_acl.{{ $network_subnet_name }}_acl.id}"
  rule_number    = 103
  egress         = false
  protocol       = "all"
  rule_action    = "allow"
  cidr_block     = "{{ index $.Build.Config "admin_ip" }}/32"
  icmp_type      = -1
  icmp_code      = -1
}
{{ end }}

{{ $current_rule_number := 200 }}

{{ range $cidr_pos, $cidr := $.Environment.AdminCIDRs }}
{{ $current_rule_number = Incr $current_rule_number }}
resource "aws_network_acl_rule" "{{ $network_subnet_name }}-{{ $team_vpc_name }}-allow-admin-{{ $cidr_pos }}" {
  network_acl_id = "${aws_network_acl.{{ $network_subnet_name }}_acl.id}"
  rule_number    = {{ $current_rule_number }}
  egress         = false
  protocol       = "all"
  rule_action    = "allow"
  cidr_block     = "{{ $cidr }}"
  icmp_type      = -1
  icmp_code      = -1
}
{{ end }}

{{ range $_, $port := $.Environment.ExposedVDIPorts }}
{{ $current_rule_number = Incr $current_rule_number }}
resource "aws_network_acl_rule" "{{ $network_subnet_name }}-{{ $team_vpc_name }}-allow-vdi-ext-{{ $port }}" {
  network_acl_id = "${aws_network_acl.{{ $network_subnet_name }}_acl.id}"
  rule_number    = {{ $current_rule_number }}
  egress         = false
  protocol       = "tcp"
  rule_action    = "allow"
  cidr_block     = "{{ index $.Build.Config "vdi_whitelist" }}"
  from_port      = {{ $port }}
  to_port        = {{ $port }}
}
{{ end }}

{{ $pnetrev := (index $.Laforge.StateManager.NewRevs $pnetid) }}
{{ $pnetrev = $pnetrev.Touch }}

resource "local_file" "lfrev-{{ $pnet.Base }}" {
  content = {{ $pnetrev.ToJSONString | hclstring }}
  filename = "./networks/{{ $pnet.Base }}/.provisioned_network.lfrevision"

  depends_on = [
    "aws_subnet.{{ $network_subnet_name }}",
  ]
}
{{ end }}

{{ $dns_resource_name := "" }}

{{ range $pnetid, $pnet := $.Team.ProvisionedNetworks }}
  {{ $netobj := $pnet.Network }}
  {{ range $phostid, $phost := $pnet.ProvisionedHosts }}
    {{ $host := $phost.Host }}
    {{ if eq $host.Base "ns01" }}
      {{ $dns_resource_name = printf "%s-t%d-%s-%s" $.Environment.Base $.Team.TeamNumber $netobj.Base $host.Base }}
    {{ end }}
  {{ end }}
{{ end }}

{{ range $pnetid, $pnet := $.Team.ProvisionedNetworks }}
  {{ $netobj := $pnet.Network }}
  {{ range $phostid, $phost := $pnet.ProvisionedHosts }}
    {{ $host := $phost.Host }}
    {{ $resource_name := printf "%s-t%d-%s-%s" $.Environment.Base $.Team.TeamNumber $netobj.Base $host.Base }}

    {{ $network_subnet_name := printf "%s-t%d-%s" $.Environment.Base $.Team.TeamNumber $netobj.Base }}

    resource "aws_network_interface" "{{ $resource_name }}-pmi" {
      subnet_id   = "${aws_subnet.{{ $network_subnet_name }}.id}"
      private_ips = ["${cidrhost("{{ $netobj.CIDR }}", {{ $host.LastOctet }})}"]
      security_groups = ["${aws_security_group.allow_all.id}"]

      tags = {
        Name = "{{ $resource_name }}-primary-network-interface"
      }
    }

    resource "aws_instance" "{{ $resource_name }}" {
      ami           = "${data.aws_ami.{{ $host.OS }}.id}"
      instance_type = "${var.vmsize["{{ $host.InstanceSize }}"]}"
      key_name = "${aws_key_pair.laforge.key_name}"

      network_interface {
        network_interface_id = "${aws_network_interface.{{ $resource_name }}-pmi.id}"
        device_index         = 0
      }

      root_block_device {
        volume_type = "gp2"
        volume_size = {{ $host.Disk.Size }}
      }

      {{ $uds := (index $host.Scripts (index $host.Vars "user_data_script_id")) }}
      user_data = "${file("{{ $.Build.RelAssetForTeam $netobj.Base $host.Base $uds.SourceBase }}")}"

      {{ if $host.AllowMACChanges }}
      source_dest_check = false
      {{ end }}

      tags = {
        EnvironmentNetwork = "{{ $.Environment.Base }}-t{{ $.Team.TeamNumber }}-{{ $netobj.Base }}",
        NetworkBase = "{{ $netobj.Base }}",
        Hostname = "{{ $host.Hostname }}",
        Team = "t{{ $.Team.TeamNumber }}",
        Environment = "{{ $.Environment.Base }}",
        Competition = "{{ $.Competition.ID }}",
        ResourceName = "{{ $resource_name }}",
        Name = "{{ $resource_name }}",
      }

    }

    {{ $phostrev := (index $.Laforge.StateManager.NewRevs $phostid) }}
    {{ $phostrev = $phostrev.TouchWithID $resource_name }}

    resource "local_file" "lfrev-{{ $resource_name }}-host" {
      content = {{ $phostrev.ToJSONString | hclstring }}
      filename = "./networks/{{ $netobj.Base }}/hosts/{{ $host.Base }}/.provisioned_host.lfrevision"

      depends_on = [
        "aws_instance.{{ $resource_name }}",
      ]
    }

    output "{{ $host.Base }}-private_ip" {
      value = "${aws_instance.{{ $resource_name }}.private_ip}"
    }

    output "{{ $host.Base }}-public_ip" {
      value = "${aws_instance.{{ $resource_name }}.public_ip}"
    }

    {{ if $host.TagEquals "vdi" "true" }}
    resource "aws_route53_record" "{{ $resource_name }}" {
      zone_id = "${aws_route53_zone.{{ $dnsz }}.zone_id}"

      name = "{{ $host.Hostname }}.{{ $netobj.Name }}.t{{ $.Team.TeamNumber }}.{{ $.Environment.Base }}.${aws_route53_zone.{{ $dnsz }}.name}"
      type = "A"
      ttl = "300"
      records = ["${aws_instance.{{ $resource_name }}.public_ip}"]
    }
    {{ end }}

    data "template_file" "{{ $resource_name }}" {
      template = "${file("{{ $.Build.RelAssetForTeam $netobj.Base $host.Base "provisioned_host.tpl" }}")}"

      vars = {
        remote_addr = "${aws_instance.{{ $resource_name }}.public_ip}"
        local_addr = "${aws_instance.{{ $resource_name }}.private_ip}"
        host_active = "true"
        resource_name = "aws_instance.{{ $resource_name }}"
        {{ if $host.IsWindows }}
        password = "{{ $phost.ActualPassword }}"
        {{ else }}
        identity_file = "{{ index $.Build.Config "rel_ssh_private_key_file" }}"
        {{ end }}
      }

      depends_on = [
        "aws_instance.{{ $resource_name }}",
      ]
    }

    resource "local_file" "{{ $resource_name }}_provisioning_file" {
      content = "${data.template_file.{{ $resource_name }}.rendered}"
      filename = "./networks/{{ $netobj.Base }}/hosts/{{ $host.Base }}/conn.laforge"

      depends_on = [
        "aws_instance.{{ $resource_name }}",
      ]
    }

    {{ $phostconnrev := (index $.Laforge.StateManager.NewRevs $phost.Conn.Path) }}
    {{ $phostconnrev = $phostconnrev.TouchWithID $resource_name }}

    resource "local_file" "lfrev-{{ $resource_name }}-conn" {
      content = {{ $phostconnrev.ToJSONString | hclstring }}
      filename = "./networks/{{ $netobj.Base }}/hosts/{{ $host.Base }}/.connection.lfrevision"

      depends_on = [
        "aws_instance.{{ $resource_name }}",
      ]
    }
  {{ end }}
{{ end }}

